# Platform Setup: macOS

**Date:** December 28, 2025  
**Status:** ⏳ Setup Guide  
**Purpose:** Configure macOS to use Rust knot_math library

---

## Overview

macOS requires Rust libraries to be compiled as dynamic libraries (`.dylib`) and linked into the Xcode project.

---

## Prerequisites

1. **Rust toolchains for macOS:**
   ```bash
   rustup target add x86_64-apple-darwin      # Intel Macs
   rustup target add aarch64-apple-darwin     # Apple Silicon Macs
   ```

2. **Xcode:** Required for macOS development

---

## Build Script

Create `scripts/build_rust_macos.sh`:

```bash
#!/bin/bash
# Build Rust library for macOS platforms

set -e

cd native/knot_math

# Detect architecture
ARCH=$(uname -m)

if [ "$ARCH" = "arm64" ]; then
    # Apple Silicon
    echo "Building for aarch64-apple-darwin..."
    cargo build --target aarch64-apple-darwin --release
    LIB_PATH="target/aarch64-apple-darwin/release/libknot_math.dylib"
else
    # Intel
    echo "Building for x86_64-apple-darwin..."
    cargo build --target x86_64-apple-darwin --release
    LIB_PATH="target/x86_64-apple-darwin/release/libknot_math.dylib"
fi

echo "✅ macOS library built successfully"
echo "Library is in: $LIB_PATH"
```

---

## Xcode Configuration

### 1. Add Rust Library to Xcode Project

1. Open `macos/Runner.xcworkspace` in Xcode
2. Add `native/knot_math/target/{arch}-apple-darwin/release/libknot_math.dylib` to project
3. Add header: `macos/Runner/knot_math_bridge.h` (generated by codegen)

### 2. Update `macos/Runner.xcodeproj/project.pbxproj`

Add library search paths:

```
LIBRARY_SEARCH_PATHS = (
  "$(SRCROOT)/../native/knot_math/target/x86_64-apple-darwin/release",
  "$(SRCROOT)/../native/knot_math/target/aarch64-apple-darwin/release",
);
```

Add to "Other Linker Flags":

```
OTHER_LDFLAGS = (
  "-lknot_math",
  // ... existing flags ...
);
```

### 3. Add Header Search Path

```
HEADER_SEARCH_PATHS = (
  "$(SRCROOT)/Runner",
  // ... existing paths ...
);
```

### 4. Update Run Script Phase

Add to "Run Script" phase in Xcode:

```bash
# Copy Rust library to app bundle
cp "${SRCROOT}/../native/knot_math/target/${ARCH}-apple-darwin/release/libknot_math.dylib" \
   "${BUILT_PRODUCTS_DIR}/${FRAMEWORKS_FOLDER_PATH}/"
```

---

## Testing

### Build and Test:

```bash
# 1. Build Rust library
./scripts/build_rust_macos.sh

# 2. Build Flutter app
flutter build macos --debug

# 3. Run macOS app
flutter run -d macos
```

### Verify Library Loading:

The library should be automatically loaded by flutter_rust_bridge when the app starts.

---

## Troubleshooting

### Library Not Found:
- Check library search paths in Xcode
- Verify library is copied to app bundle
- Check "Other Linker Flags" configuration

### Architecture Mismatch:
- Build for both architectures if distributing
- Use universal binary for easier distribution

### Build Errors:
- Verify Rust toolchains are installed
- Check Xcode project configuration
- Ensure header file is added to project

---

**Status:** ⏳ Setup Guide Complete - Ready for Implementation
