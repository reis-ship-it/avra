# Platform Setup: iOS

**Date:** December 28, 2025  
**Status:** ⏳ Setup Guide  
**Purpose:** Configure iOS to use Rust knot_math library

---

## Overview

iOS requires Rust libraries to be compiled as static libraries (`.a`) and linked into the Xcode project.

---

## Prerequisites

1. **Rust toolchains for iOS:**
   ```bash
   rustup target add aarch64-apple-ios        # iOS devices
   rustup target add x86_64-apple-ios            # iOS simulator (Intel)
   rustup target add aarch64-apple-ios-sim        # iOS simulator (Apple Silicon)
   ```

2. **Xcode:** Required for iOS development

3. **cargo-xcode (optional):** For easier Xcode project generation
   ```bash
   cargo install cargo-xcode
   ```

---

## Build Script

Create `scripts/build_rust_ios.sh`:

```bash
#!/bin/bash
# Build Rust library for iOS platforms

set -e

cd native/knot_math

# Build for iOS device (ARM64)
echo "Building for aarch64-apple-ios..."
cargo build --target aarch64-apple-ios --release

# Build for iOS simulator (Intel)
echo "Building for x86_64-apple-ios..."
cargo build --target x86_64-apple-ios --release

# Build for iOS simulator (Apple Silicon)
echo "Building for aarch64-apple-ios-sim..."
cargo build --target aarch64-apple-ios-sim --release

echo "✅ iOS libraries built successfully"
echo "Libraries are in: target/{target}/release/libknot_math.a"
```

---

## Xcode Configuration

### 1. Add Rust Library to Xcode Project

**Option A: Manual (Recommended for now)**

1. Open `ios/Runner.xcworkspace` in Xcode
2. Add `native/knot_math/target/aarch64-apple-ios/release/libknot_math.a` to project
3. Add header: `ios/Runner/knot_math_bridge.h` (generated by codegen)

**Option B: Using cargo-xcode**

```bash
cd native/knot_math
cargo xcode
# This generates an Xcode project for the Rust library
```

### 2. Update `ios/Podfile`

Add Rust library path:

```ruby
target 'Runner' do
  use_frameworks!
  use_modular_headers!
  
  # ... existing pods ...
  
  # Rust library (if using framework approach)
  # pod 'knot_math', :path => '../native/knot_math'
end
```

### 3. Update `ios/Runner.xcodeproj/project.pbxproj`

Add library search paths:

```
LIBRARY_SEARCH_PATHS = (
  "$(SRCROOT)/../native/knot_math/target/aarch64-apple-ios/release",
  "$(SRCROOT)/../native/knot_math/target/x86_64-apple-ios/release",
  "$(SRCROOT)/../native/knot_math/target/aarch64-apple-ios-sim/release",
);
```

Add to "Other Linker Flags":

```
OTHER_LDFLAGS = (
  "-lknot_math",
  // ... existing flags ...
);
```

### 4. Add Header Search Path

```
HEADER_SEARCH_PATHS = (
  "$(SRCROOT)/Runner",
  // ... existing paths ...
);
```

---

## Universal Framework (Optional)

For easier distribution, create a universal framework:

```bash
# Create universal framework script
./scripts/create_ios_framework.sh
```

This combines device and simulator libraries into a single framework.

---

## Testing

### Build and Test:

```bash
# 1. Build Rust libraries
./scripts/build_rust_ios.sh

# 2. Build Flutter app
flutter build ios --debug

# 3. Run on iOS device/simulator
flutter run
```

### Verify Library Loading:

The library should be automatically loaded by flutter_rust_bridge when the app starts.

---

## Troubleshooting

### Library Not Found:
- Check library search paths in Xcode
- Verify library names match (`libknot_math.a`)
- Check "Other Linker Flags" configuration

### Architecture Mismatch:
- Ensure correct target is built for device vs simulator
- Use universal framework for easier distribution

### Build Errors:
- Verify Rust toolchains are installed
- Check Xcode project configuration
- Ensure header file is added to project

---

**Status:** ⏳ Setup Guide Complete - Ready for Implementation
