# Cursor Rule: Integration Optimization

## üéØ MANDATORY RULE: Phase Integration Optimization

**ALL phases MUST follow integration optimization principles to ensure smooth handoffs.**

**This is NON-NEGOTIABLE and enforced by cursor rules.**

**Reference:** `docs/INTEGRATION_OPTIMIZATION_PLAN.md` - Complete integration optimization guide

---

## üö® **CRITICAL: Phase Handoff Requirements**

### **When Completing a Phase:**

**MANDATORY: Before marking a phase complete, you MUST:**

1. **Create Output Contracts Document:**
   - Create `docs/plans/[phase_name]/PHASE_X_OUTPUT_CONTRACTS.md`
   - Document all services produced
   - Document all models produced
   - Document all database changes
   - Document integration points for dependent phases
   - Document any breaking changes

2. **Create Breaking Changes Document (if applicable):**
   - Create `docs/plans/[phase_name]/PHASE_X_BREAKING_CHANGES.md`
   - Document all service breaking changes
   - Document all model breaking changes
   - Document all database breaking changes
   - List affected phases
   - Provide migration guides

3. **Update Service Registry:**
   - Update `docs/SERVICE_REGISTRY.md` with new services
   - Update service status (Stable, Migrating, In Progress)
   - Update dependent phases list
   - Document service locking status

4. **Write Integration Tests:**
   - Create integration tests for all phase handoffs
   - Create service contract tests
   - Ensure all tests pass before marking phase complete

### **When Starting a Phase:**

**MANDATORY: Before starting a phase, you MUST:**

1. **Create Input Requirements Document:**
   - Create `docs/plans/[phase_name]/PHASE_X_INPUT_REQUIREMENTS.md`
   - Document all required services
   - Document all required models
   - Document all required database tables
   - Verify all dependencies are available
   - Complete integration checklist

2. **Verify Dependencies:**
   - Check that all required services exist
   - Check that all required models exist
   - Check that all required database tables exist
   - Verify integration tests pass for dependencies
   - Confirm phase is ready to start

3. **Check Service Registry:**
   - Verify required services are not locked
   - Check for breaking changes in dependencies
   - Review migration requirements

---

## üìã **Service Modification Rules**

### **Before Modifying a Service:**

**MANDATORY: Before modifying any service, you MUST:**

1. **Check Service Registry:**
   - Verify service is not locked by another phase
   - Check dependent phases list
   - Review breaking change impact

2. **Announce Breaking Changes (if applicable):**
   - Create breaking changes document
   - Notify all dependent phases (2 weeks before implementation)
   - Provide migration guide
   - Set deprecation timeline (4 weeks minimum)

3. **Lock Service:**
   - Update service registry with lock status
   - Document lock period (modification duration + 1 week testing)
   - Notify dependent phases

4. **After Modification:**
   - Update service registry with new version
   - Unlock service after tests pass
   - Update integration tests

### **Service Locking Rules:**

- **During Modification:** Service is "locked" - read-only for other phases
- **Breaking Changes:** Must be announced 2 weeks before implementation
- **Deprecation:** 4-week deprecation period before removal
- **Lock Period:** Duration of modification + 1 week for testing

---

## üß™ **Integration Test Requirements**

### **MANDATORY: Integration Tests Must Exist**

**For Every Phase Handoff:**

1. **Phase Handoff Tests:**
   - Create `test/integration/phase_handoffs/phase_X_to_phase_Y_test.dart`
   - Validate that Phase X outputs work with Phase Y inputs
   - Test all integration points
   - Ensure all tests pass before Phase Y starts

2. **Service Contract Tests:**
   - Create `test/integration/phase_handoffs/service_contract_tests/[service]_contract_test.dart`
   - Validate service interfaces match requirements
   - Test all required methods exist
   - Ensure contracts are maintained

3. **Test Execution:**
   - All integration tests must pass before phase completion
   - All service contract tests must pass before phase completion
   - Tests must be added to CI/CD pipeline

---

## üîÑ **Parallel Execution Rules**

### **MANDATORY: Optimize for Parallel Execution**

**When Planning Phases:**

1. **Check Dependencies:**
   - Identify phases with no dependencies
   - Identify phases that can start immediately
   - Document parallel execution opportunities

2. **Update Master Plan:**
   - Structure phases into execution tiers:
     - Tier 1: Critical Blockers (Sequential)
     - Tier 2: Can Start Immediately (Parallel)
     - Tier 3: Quality Assurance (After dependencies)
     - Tier 4: Require Dependencies (Parallel after dependencies)
     - Tier 5: Independent (Anytime)

3. **Document Parallel Execution:**
   - Update `docs/MASTER_PLAN.md` with parallel execution structure
   - Calculate time savings
   - Ensure dependencies are respected

---

## üóÑÔ∏è **Database Migration Rules**

### **MANDATORY: Migration Coordination**

**Before Creating Database Migrations:**

1. **Check Migration Order:**
   - Review `docs/DATABASE_MIGRATION_ORDER.md`
   - Verify migration dependencies
   - Ensure migrations are properly sequenced

2. **Announce Migration:**
   - Announce 1 week before migration
   - Document locked tables
   - Document lock duration
   - List affected phases

3. **Test Migration:**
   - Test migration on staging
   - Validate rollback procedure
   - Run integration tests after migration

4. **Update Migration Order:**
   - Update `docs/DATABASE_MIGRATION_ORDER.md`
   - Document migration in dependency graph
   - Update lock periods

---

## üèóÔ∏è **Foundational Services Rules**

### **MANDATORY: Foundational Services Usage**

**For All New Features:**

1. **Use Foundational Services:**
   - **AtomicClockService:** All timestamp features MUST use AtomicClockService (not `DateTime.now()`)
   - **AgentIdService:** All user identification MUST use agentId (not userId)
   - **StorageService:** All storage operations MUST use StorageService
   - **LoggerService:** All logging MUST use LoggerService (not `print()`)

2. **Code Review Checklist:**
   - Verify AtomicClockService usage for timestamps
   - Verify agentId usage (not userId)
   - Verify StorageService usage
   - Verify LoggerService usage

3. **Migration Plan:**
   - Convert existing `DateTime.now()` to AtomicClockService
   - Convert existing `userId` to `agentId`
   - Update all services to use foundational services

---

## ‚úÖ **Verification Checklist**

### **Before Marking Phase Complete:**

- [ ] Output contracts document created
- [ ] Breaking changes document created (if applicable)
- [ ] Service registry updated
- [ ] Integration tests written and passing
- [ ] Service contract tests written and passing
- [ ] All dependencies documented
- [ ] Migration coordination complete (if applicable)

### **Before Starting Phase:**

- [ ] Input requirements document created
- [ ] All dependencies verified available
- [ ] Integration checklist complete
- [ ] Service registry checked (no locks)
- [ ] Breaking changes reviewed
- [ ] Integration tests pass for dependencies

### **Before Modifying Service:**

- [ ] Service registry checked (not locked)
- [ ] Breaking changes announced (if applicable)
- [ ] Dependent phases notified
- [ ] Migration guide provided
- [ ] Service locked in registry
- [ ] Integration tests updated

---

## üìö **Reference Documents**

**MANDATORY READING:**
- `docs/INTEGRATION_OPTIMIZATION_PLAN.md` - Complete integration optimization guide
- `docs/MASTER_PLAN.md` - Main execution plan
- `docs/SERVICE_REGISTRY.md` - Service registry (create if doesn't exist)
- `docs/DATABASE_MIGRATION_ORDER.md` - Migration coordination (create if doesn't exist)

**Templates:**
- `docs/plans/[phase_name]/PHASE_X_OUTPUT_CONTRACTS.md` - Output contracts template
- `docs/plans/[phase_name]/PHASE_X_INPUT_REQUIREMENTS.md` - Input requirements template
- `docs/plans/[phase_name]/PHASE_X_BREAKING_CHANGES.md` - Breaking changes template

---

## üö® **Enforcement**

**This rule is MANDATORY and enforced by:**
- Code review process
- Integration test requirements
- Phase completion verification
- Service modification approval

**Violations will block:**
- Phase completion
- Service modifications
- Integration handoffs

---

**Last Updated:** December 23, 2025  
**Status:** Active - Mandatory for all phases

